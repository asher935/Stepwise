services:
  stepwise-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    ports:
      - "3000:3000"
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - MAX_SESSIONS=${MAX_SESSIONS:-5}
      - IDLE_TIMEOUT_MS=${IDLE_TIMEOUT_MS:-1800000}
      - MAX_STEPS_PER_SESSION=${MAX_STEPS_PER_SESSION:-200}
      - BROWSER_VIEWPORT_WIDTH=${BROWSER_VIEWPORT_WIDTH:-1280}
      - BROWSER_VIEWPORT_HEIGHT=${BROWSER_VIEWPORT_HEIGHT:-800}
      - SCREENCAST_QUALITY=${SCREENCAST_QUALITY:-80}
      - SCREENSHOT_QUALITY=${SCREENSHOT_QUALITY:-95}
      - SCREENSHOT_FORMAT=${SCREENSHOT_FORMAT:-png}
      - SCREENCAST_MAX_FPS=${SCREENCAST_MAX_FPS:-15}
      - TEMP_DIR=/tmp/stepwise
    volumes:
      - ..:/app
      - stepwise-node-modules:/app/node_modules
      - stepwise-bun:/root/.bun
      - stepwise-tmp:/tmp/stepwise
    working_dir: /app
    command: sh -lc "bun install && bun run dev"
    shm_size: "2gb"

volumes:
  stepwise-node-modules:
  stepwise-bun:
  stepwise-tmp:
